Bootstrap: docker
From: rockylinux:9

%post
    # Update package repository
    dnf -y update

    # Install EPEL repository and required packages
    dnf install -y epel-release
    dnf -y install \
        git \
        wget \
        java-1.8.0-openjdk \
        java-1.8.0-openjdk-devel \
        autoconf \
        automake \
        make \
        zip \
        unzip \
        gcc \
        perl-Data-Dumper \
        zlib-devel \
        bzip2 \
        bzip2-devel \
        xz-devel \
        curl-devel \
        openssl-devel \
        ncurses-devel \
        graphviz

    # Clean up DNF cache
    dnf clean all
    rm -rf /var/cache/dnf /tmp/*

    APPS_ROOT=/sing_tools
    mkdir -p ${APPS_ROOT}

    ###############################################
    # Install FASTP
    FASTP_VERSION=0.23.4
    FASTP_HOME=${APPS_ROOT}/fastp/${FASTP_VERSION}
    FASTP_BIN=${FASTP_HOME}/fastp

    mkdir -p ${FASTP_HOME}
    wget http://opengene.org/fastp/fastp.${FASTP_VERSION} -O ${FASTP_BIN}
    chmod a+x ${FASTP_BIN}
    rm -f fastp.${FASTP_VERSION}

    ###############################################
    # Install BWA
    BWA_VERSION=0.7.17
    BWA_HOME=${APPS_ROOT}/bwa/${BWA_VERSION}
    PATH=${BWA_HOME}:${PATH}

    git clone --branch v${BWA_VERSION} https://github.com/lh3/bwa.git ${BWA_HOME}
    cd ${BWA_HOME} && make
    cd /
    rm -rf ${BWA_HOME}/.git

    ###############################################
    # Install Picard
    PICARD_VERSION=2.17.11
    JAVA_HOME=/etc/alternatives/jre
    PICARD_HOME=${APPS_ROOT}/picard/${PICARD_VERSION}
    PICARD_JAR=${PICARD_HOME}/picard-${PICARD_VERSION}.jar

    mkdir -p ${PICARD_HOME}
    wget https://github.com/broadinstitute/picard/releases/download/${PICARD_VERSION}/picard.jar -O ${PICARD_JAR}

    ###############################################
    # Install GATK
    GATK_VERSION=4.6.1.0
    GATK_HOME=${APPS_ROOT}/gatk/${GATK_VERSION}

    wget https://github.com/broadinstitute/gatk/releases/download/${GATK_VERSION}/gatk-${GATK_VERSION}.zip
    unzip gatk-${GATK_VERSION}.zip -d ${APPS_ROOT}/gatk
    mv ${APPS_ROOT}/gatk/gatk-${GATK_VERSION} ${GATK_HOME}
    rm -f gatk-${GATK_VERSION}.zip

    ###############################################
    # Install HTSLIB
    HTSLIB_VERSION=1.19.1
    HTSLIB_HOME=${APPS_ROOT}/htslib/${HTSLIB_VERSION}

    wget https://github.com/samtools/htslib/releases/download/${HTSLIB_VERSION}/htslib-${HTSLIB_VERSION}.tar.bz2
    tar xjf htslib-${HTSLIB_VERSION}.tar.bz2
    cd htslib-${HTSLIB_VERSION}
    ./configure --prefix=${HTSLIB_HOME}
    make && make install
    cd /
    rm -rf htslib-${HTSLIB_VERSION} htslib-${HTSLIB_VERSION}.tar.bz2

    ###############################################
    # Install BCFTOOLS
    BCFTOOLS_VERSION=1.19
    BCFTOOLS_HOME=${APPS_ROOT}/bcftools/${BCFTOOLS_VERSION}

    wget https://github.com/samtools/bcftools/releases/download/${BCFTOOLS_VERSION}/bcftools-${BCFTOOLS_VERSION}.tar.bz2
    tar xjf bcftools-${BCFTOOLS_VERSION}.tar.bz2
    cd bcftools-${BCFTOOLS_VERSION}
    ./configure --prefix=${BCFTOOLS_HOME} --with-htslib=${HTSLIB_HOME}
    make && make install
    cd /
    rm -rf bcftools-${BCFTOOLS_VERSION} bcftools-${BCFTOOLS_VERSION}.tar.bz2

    ###############################################
    # Install SAMTOOLS
    SAMTOOLS_VERSION=1.19.2
    SAMTOOLS_HOME=${APPS_ROOT}/samtools/${SAMTOOLS_VERSION}

    wget https://github.com/samtools/samtools/releases/download/${SAMTOOLS_VERSION}/samtools-${SAMTOOLS_VERSION}.tar.bz2
    tar xjf samtools-${SAMTOOLS_VERSION}.tar.bz2
    cd samtools-${SAMTOOLS_VERSION}
    ./configure --prefix=${SAMTOOLS_HOME} --with-htslib=${HTSLIB_HOME}
    make && make install
    cd /
    rm -rf samtools-${SAMTOOLS_VERSION} samtools-${SAMTOOLS_VERSION}.tar.bz2

    # Final cleanup to remove any remaining temp files
    rm -rf /tmp/*

%environment
export APPS_ROOT=/sing_tools
export BWA_VERSION=0.7.17
export BWA_HOME=${APPS_ROOT}/bwa/${BWA_VERSION}
export PATH=${BWA_HOME}:${PATH}
export PICARD_VERSION=2.17.11
export JAVA_HOME=/etc/alternatives/jre
export PICARD_HOME=${APPS_ROOT}/picard/${PICARD_VERSION}
export PICARD_JAR=${PICARD_HOME}/picard-${PICARD_VERSION}.jar
export FASTP_VERSION=0.23.4
export FASTP_HOME=${APPS_ROOT}/fastp/${FASTP_VERSION}
export PATH=${FASTP_HOME}:${PATH}
export GATK_VERSION=4.6.1.0
export GATK_HOME=${APPS_ROOT}/gatk/${GATK_VERSION}
export PATH=${GATK_HOME}:${PATH}
export HTSLIB_VERSION=1.19.1
export HTSLIB_HOME=${APPS_ROOT}/htslib/${HTSLIB_VERSION}
export PATH=${HTSLIB_HOME}/bin:${PATH}
export LD_LIBRARY_PATH=${HTSLIB_HOME}/lib:${LD_LIBRARY_PATH}
export SAMTOOLS_VERSION=1.19.2
export SAMTOOLS_HOME=${APPS_ROOT}/samtools/${SAMTOOLS_VERSION}
export PATH=${SAMTOOLS_HOME}/bin:${PATH}
export LD_LIBRARY_PATH=${SAMTOOLS_HOME}/lib:${LD_LIBRARY_PATH}
export BCFTOOLS_VERSION=1.19
export BCFTOOLS_HOME=${APPS_ROOT}/bcftools/${BCFTOOLS_VERSION}
export PATH=${BCFTOOLS_HOME}/bin:${PATH}

%runscript
exec /bin/bash "$@"

%startscript
exec /bin/bash "$@"

